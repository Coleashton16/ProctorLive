<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProctorLive | Instructor Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, 
        deleteDoc, updateDoc, doc, serverTimestamp, query, orderBy, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCaex4bB5r2lVHPblC5pc0wCPIl8uUbtKw",
      authDomain: "proctorlive-dae37.firebaseapp.com",
      projectId: "proctorlive-dae37",
      storageBucket: "proctorlive-dae37.firebasestorage.app",
      messagingSenderId: "1063605117912",
      appId: "1:1063605117912:web:eea13aa3e743d55ee308ad",
      measurementId: "G-5RSFDE9W8Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const Icon = ({ name, size = 20, className = "" }) => {
        const icons = {
            plus: <path d="M12 5v14M5 12h14" />,
            list: <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />,
            trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />,
            check: <path d="M20 6L9 17l-5-5" />,
            layout: <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" />,
            users: <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />,
            book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />,
            chart: <path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3" />,
            clock: <path d="M12 2v20M2 12h20" />,
            eye: <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8zM12 5c-3.866 0-7 5.134-7 7 0 1.866 3.134 7 7 7 3.866 0 7-5.134 7-7 0-1.866-3.134-7-7-7z" />,
            xCircle: <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />,
            chevronDown: <path d="M6 9l6 6 6-6" />,
            chevronUp: <path d="M18 15l-6-6-6 6" />
        };
        return (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" 
                fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                className={className}>
                {icons[name] || icons.plus}
            </svg>
        );
    };

    function App() {
        const [activeTab, setActiveTab] = React.useState('exams');
        const [selectedExamId, setSelectedExamId] = React.useState(null);
        const [notification, setNotification] = React.useState(null);

        const showNotification = (msg, type = 'success') => {
            setNotification({ msg, type });
            setTimeout(() => setNotification(null), 3000);
        };

        const handleTabChange = (tab) => {
            if ((tab === 'add' || tab === 'list') && !selectedExamId) {
                showNotification("Please select an Exam from 'My Exams' first!", "error");
                setActiveTab('exams');
                return;
            }
            setActiveTab(tab);
        };

        return (
            <div className="min-h-screen flex flex-col md:flex-row">
                <aside className="w-full md:w-64 bg-slate-900 text-white flex flex-col shrink-0">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold flex items-center gap-2">
                            <Icon name="layout" className="text-blue-400" />
                            ProctorLive
                        </h1>
                        <p className="text-slate-400 text-xs mt-1">Instructor Dashboard</p>
                    </div>
                    
                    <nav className="flex-1 p-4 space-y-2">
                        <button onClick={() => handleTabChange('exams')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'exams' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800'}`}>
                            <Icon name="book" /> My Exams
                        </button>
                        <button onClick={() => handleTabChange('results')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'results' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800'}`}>
                            <Icon name="chart" /> Student Results
                        </button>
                        <div className="pt-4 pb-2 px-4 text-xs font-bold text-slate-500 uppercase">Editor</div>
                        <button onClick={() => handleTabChange('add')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'add' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800'}`}>
                            <Icon name="plus" /> Add Question
                        </button>
                        <button onClick={() => handleTabChange('list')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'list' ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800'}`}>
                            <Icon name="list" /> Question Bank
                        </button>
                    </nav>

                    {selectedExamId && (
                        <div className="p-4 bg-slate-800 mx-4 mb-4 rounded border border-slate-700">
                            <p className="text-xs text-slate-400 uppercase font-bold mb-1">Active Exam Context</p>
                            <div className="flex items-center gap-2 text-green-400 font-mono text-sm">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Selected
                            </div>
                        </div>
                    )}
                </aside>

                <main className="flex-1 p-6 md:p-10 overflow-hidden flex flex-col h-screen">
                    <div className="flex justify-between items-center mb-6 shrink-0">
                        <h2 className="text-2xl font-bold text-slate-800">
                            {activeTab === 'exams' && 'Exam Management'}
                            {activeTab === 'results' && 'Student Results & Grading'}
                            {activeTab === 'add' && 'Create New Question'}
                            {activeTab === 'list' && 'Review Questions'}
                        </h2>
                    </div>

                    {notification && (
                        <div className={`fixed top-5 right-5 z-50 px-6 py-4 rounded shadow-lg text-white animate-bounce ${notification.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                            {notification.msg}
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden relative">
                        {activeTab === 'exams' && 
                            <ExamManager 
                                db={db} 
                                showNotification={showNotification} 
                                onSelectExam={(id) => { setSelectedExamId(id); setActiveTab('add'); }}
                                selectedId={selectedExamId}
                            />
                        }
                        {activeTab === 'results' && 
                            <ResultsViewer db={db} showNotification={showNotification} />
                        }
                        {activeTab === 'add' && 
                            <AddQuestionForm 
                                db={db} 
                                examId={selectedExamId} 
                                showNotification={showNotification} 
                            />
                        }
                        {activeTab === 'list' && 
                            <QuestionList 
                                db={db} 
                                examId={selectedExamId} 
                                showNotification={showNotification} 
                            />
                        }
                    </div>
                </main>
            </div>
        );
    }

    // --- 1. EXAM MANAGER ---
    function ExamManager({ db, showNotification, onSelectExam, selectedId }) {
        const [exams, setExams] = React.useState([]);
        const [newExamTitle, setNewExamTitle] = React.useState("");
        const [timeLimit, setTimeLimit] = React.useState(60);
        const [creating, setCreating] = React.useState(false);
        const [editingAccess, setEditingAccess] = React.useState(null); 
        const [accessText, setAccessText] = React.useState("");

        React.useEffect(() => {
            const q = query(collection(db, "exams"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedExams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fetchedExams.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                setExams(fetchedExams);
            });
            return () => unsubscribe();
        }, []);

        const handleCreate = async (e) => {
            e.preventDefault();
            if (!newExamTitle.trim()) return;
            setCreating(true);
            try {
                await addDoc(collection(db, "exams"), {
                    title: newExamTitle,
                    timeLimit: parseInt(timeLimit),
                    createdAt: serverTimestamp(),
                    allowedEmails: [],
                    status: 'open'
                });
                showNotification("Exam created!");
                setNewExamTitle("");
            } catch (err) {
                showNotification("Error: " + err.message, "error");
            } finally {
                setCreating(false);
            }
        };

        const saveAccessList = async (examId) => {
            const emails = accessText.split(',').map(e => e.trim()).filter(e => e !== "");
            try {
                await updateDoc(doc(db, "exams", examId), { allowedEmails: emails });
                showNotification("Access list updated!");
                setEditingAccess(null);
            } catch (err) {
                showNotification("Error updating access", "error");
            }
        };

        return (
            <div className="flex flex-col h-full">
                <div className="p-6 border-b border-slate-100 bg-slate-50">
                    <form onSubmit={handleCreate} className="flex gap-4 items-end">
                        <div className="flex-1">
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Exam Title</label>
                            <input type="text" value={newExamTitle} onChange={(e) => setNewExamTitle(e.target.value)} placeholder="e.g. 'Cardiology Review'" className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <div className="w-32">
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Time (Mins)</label>
                            <input type="number" value={timeLimit} onChange={(e) => setTimeLimit(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" required min="1" />
                        </div>
                        <button type="submit" disabled={creating} className={`bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 h-[50px] transition-colors ${creating ? 'bg-slate-400' : ''}`}>
                            {creating ? '...' : 'Create'}
                        </button>
                    </form>
                </div>

                <div className="flex-1 overflow-y-auto p-6 scroller grid grid-cols-1 lg:grid-cols-2 gap-6 content-start">
                    {exams.map(exam => (
                        <div key={exam.id} className={`border rounded-xl p-5 transition-all ${selectedId === exam.id ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50/30' : 'border-slate-200 hover:border-blue-300'}`}>
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800">{exam.title}</h3>
                                    <p className="text-xs text-slate-500">ID: {exam.id} | {exam.timeLimit || 60} Mins</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => onSelectExam(exam.id)} className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold hover:bg-blue-200">
                                        {selectedId === exam.id ? 'Selected' : 'Select'}
                                    </button>
                                </div>
                            </div>

                            <div className="bg-white border border-slate-200 rounded p-3 mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><Icon name="users" size={14} /> Access List</span>
                                    {editingAccess !== exam.id && (
                                        <button onClick={() => { setEditingAccess(exam.id); setAccessText((exam.allowedEmails || []).join(', ')); }} className="text-xs text-blue-600 hover:underline">Edit</button>
                                    )}
                                </div>
                                
                                {editingAccess === exam.id ? (
                                    <div className="space-y-2">
                                        <textarea value={accessText} onChange={(e) => setAccessText(e.target.value)} className="w-full text-sm p-2 border rounded" rows="3" placeholder="email1@school.edu, email2@school.edu" />
                                        <div className="flex gap-2 justify-end">
                                            <button onClick={() => setEditingAccess(null)} className="text-xs text-slate-500">Cancel</button>
                                            <button onClick={() => saveAccessList(exam.id)} className="text-xs bg-green-600 text-white px-3 py-1 rounded">Save</button>
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-600 truncate">
                                        {exam.allowedEmails && exam.allowedEmails.length > 0 ? exam.allowedEmails.join(", ") : <span className="text-slate-400 italic">Public (All allowed)</span>}
                                    </p>
                                )}
                            </div>

                            <button onClick={() => onSelectExam(exam.id)} className="w-full py-2 border border-blue-200 text-blue-600 rounded hover:bg-blue-50 font-medium text-sm flex items-center justify-center gap-2">
                                <Icon name="plus" size={16} /> Edit Questions
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    // --- 2. RESULTS VIEWER (UPDATED WITH EXPLICIT BUTTON NEXT TO EMAIL) ---
    function ResultsViewer({ db }) {
        const [exams, setExams] = React.useState([]);
        const [selectedExam, setSelectedExam] = React.useState(null);
        const [sessions, setSessions] = React.useState([]);
        const [questions, setQuestions] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [expandedSessionId, setExpandedSessionId] = React.useState(null);

        React.useEffect(() => {
            getDocs(collection(db, "exams")).then(snap => setExams(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        }, []);

        const loadResults = async (examId) => {
            if (!examId) return;
            setLoading(true);
            setExpandedSessionId(null);
            const ex = exams.find(e => e.id === examId);
            setSelectedExam(ex);
            
            const qSnap = await getDocs(query(collection(db, "questions"), where("examId", "==", examId)));
            const qs = qSnap.docs.map(d => ({id: d.id, ...d.data()}));
            qs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            setQuestions(qs);

            const sSnap = await getDocs(query(collection(db, "sessions"), where("examId", "==", examId)));
            const sess = sSnap.docs.map(d => ({id: d.id, ...d.data()}));
            sess.sort((a,b) => (b.lastActive?.seconds || 0) - (a.lastActive?.seconds || 0));
            setSessions(sess);
            setLoading(false);
        };

        const calculateScore = (session) => {
            if (!session.answers || questions.length === 0) return 0;
            let score = 0;
            questions.forEach(q => {
                const studentAns = session.answers[q.id];
                if (studentAns) {
                    const studentSel = studentAns.selectedOptions || [];
                    const correctSel = q.correctIndices || [q.correctAnswerIndex];
                    if ([...studentSel].sort().join(',') === [...correctSel].sort().join(',')) score++;
                }
            });
            return Math.round((score / questions.length) * 100);
        };

        const formatOptions = (indices) => {
            if (!indices || indices.length === 0) return "-";
            return indices.map(i => String.fromCharCode(65 + parseInt(i))).join(', ');
        };

        const getFullReport = (session) => {
            return questions.map((q, idx) => {
                const studentAns = session.answers ? session.answers[q.id] : null;
                const studentSel = studentAns ? (studentAns.selectedOptions || []) : [];
                const correctSel = q.correctIndices || [q.correctAnswerIndex];
                const s1 = [...studentSel].sort().join(',');
                const s2 = [...correctSel].sort().join(',');
                const isCorrect = s1 === s2;

                return {
                    id: q.id,
                    qNum: idx + 1,
                    text: q.text,
                    studentVal: formatOptions(studentSel),
                    correctVal: formatOptions(correctSel),
                    isSATA: q.isSATA,
                    isCorrect: isCorrect,
                    rationale: q.rationale
                };
            });
        };

        const toggleDetails = (id) => {
            if (expandedSessionId === id) setExpandedSessionId(null);
            else setExpandedSessionId(id);
        };

        return (
            <div className="flex flex-col h-full">
                <div className="p-6 border-b border-slate-100 bg-slate-50">
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Select Exam to Grade</label>
                    <select onChange={(e) => loadResults(e.target.value)} className="w-full max-w-md p-3 border rounded-lg">
                        <option value="">-- Choose Exam --</option>
                        {exams.map(e => <option key={e.id} value={e.id}>{e.title}</option>)}
                    </select>
                </div>
                <div className="flex-1 overflow-y-auto p-6 scroller">
                    {loading && <div className="text-center text-slate-500 py-10">Loading and Grading...</div>}
                    {!loading && selectedExam && (
                        <table className="w-full text-left border-collapse bg-white rounded-lg shadow-sm overflow-hidden">
                            <thead className="bg-slate-100 text-slate-600 text-sm font-bold">
                                <tr>
                                    <th className="p-4 border-b">Student Name</th>
                                    <th className="p-4 border-b">Email</th>
                                    <th className="p-4 border-b w-32">Action</th>
                                    <th className="p-4 border-b">Status</th>
                                    <th className="p-4 border-b">Score</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {sessions.length === 0 ? (
                                    <tr><td colSpan="5" className="p-6 text-center text-slate-500">No student sessions found.</td></tr>
                                ) : (
                                    sessions.map(sess => {
                                        const score = calculateScore(sess);
                                        const isExpanded = expandedSessionId === sess.id;
                                        return (
                                            <React.Fragment key={sess.id}>
                                                <tr className={`hover:bg-slate-50 transition-colors ${isExpanded ? 'bg-blue-50' : ''}`}>
                                                    <td className="p-4 font-medium text-slate-800">{sess.studentName}</td>
                                                    <td className="p-4 text-slate-500 text-sm">{sess.studentEmail}</td>
                                                    <td className="p-4">
                                                        <button 
                                                            onClick={() => toggleDetails(sess.id)}
                                                            className={`text-xs font-bold py-1 px-3 rounded flex items-center gap-1 transition-colors border ${isExpanded ? 'bg-slate-200 text-slate-700 border-slate-300' : 'bg-white text-blue-600 border-blue-200 hover:bg-blue-50'}`}
                                                        >
                                                            {isExpanded ? 'Hide' : 'Review'} <Icon name="eye" size={12} />
                                                        </button>
                                                    </td>
                                                    <td className="p-4">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold ${sess.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                                            {sess.status ? sess.status.toUpperCase() : 'ACTIVE'}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 font-bold text-lg text-slate-800">{questions.length > 0 ? `${score}%` : 'N/A'}</td>
                                                </tr>
                                                {isExpanded && (
                                                    <tr>
                                                        <td colSpan="5" className="p-0">
                                                            <div className="bg-slate-50 p-6 border-b border-slate-200 shadow-inner">
                                                                <h4 className="text-sm font-bold text-slate-700 uppercase mb-4 flex items-center gap-2">
                                                                    <Icon name="list" size={16} /> Full Exam Report
                                                                </h4>
                                                                
                                                                <div className="space-y-3">
                                                                    {getFullReport(sess).map((item) => (
                                                                        <div key={item.id} className={`p-4 rounded border-l-4 ${item.isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'} border-y border-r border-slate-200 bg-white`}>
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <p className="text-slate-800 font-medium text-sm w-3/4">
                                                                                    <span className="font-bold text-slate-500 mr-2">Q{item.qNum}.</span>
                                                                                    {item.text}
                                                                                </p>
                                                                                {item.isCorrect 
                                                                                    ? <span className="text-xs font-bold bg-green-200 text-green-800 px-2 py-1 rounded flex items-center gap-1 shrink-0"><Icon name="check" size={12} /> Correct</span>
                                                                                    : <span className="text-xs font-bold bg-red-200 text-red-800 px-2 py-1 rounded flex items-center gap-1 shrink-0"><Icon name="xCircle" size={12} /> Incorrect</span>
                                                                                }
                                                                            </div>
                                                                            
                                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs mt-3 bg-slate-50 p-3 rounded border border-slate-100">
                                                                                <div>
                                                                                    <span className="font-bold text-slate-500 block mb-1 uppercase text-[10px]">Student Answer</span>
                                                                                    <span className={`font-mono font-bold text-base ${item.isCorrect ? 'text-green-700' : 'text-red-600'}`}>
                                                                                        {item.studentVal || '(No Answer)'}
                                                                                    </span>
                                                                                </div>
                                                                                <div>
                                                                                    <span className="font-bold text-slate-500 block mb-1 uppercase text-[10px]">Correct Answer</span>
                                                                                    <span className="font-mono font-bold text-base text-slate-700">
                                                                                        {item.correctVal}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            {item.rationale && (
                                                                                <div className="mt-3 text-sm text-slate-600 border-t border-slate-100 pt-2">
                                                                                    <span className="font-bold text-slate-700">Rationale:</span> {item.rationale}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )}
                                            </React.Fragment>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        );
    }

    // --- 3. ADD QUESTION FORM ---
    function AddQuestionForm({ db, examId, showNotification }) {
        const [isSATA, setIsSATA] = React.useState(false);
        const [loading, setLoading] = React.useState(false);
        const [formData, setFormData] = React.useState({ text: '', opt1: '', opt2: '', opt3: '', opt4: '', rationale: '' });
        const [correctIndices, setCorrectIndices] = React.useState([]);

        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
        const toggleCorrect = (idx) => {
            if (isSATA) { if (correctIndices.includes(idx)) setCorrectIndices(correctIndices.filter(i => i !== idx)); else setCorrectIndices([...correctIndices, idx]); } 
            else setCorrectIndices([idx]);
        };
        const handleSubmit = async (e) => {
            e.preventDefault();
            if (correctIndices.length === 0 || !examId) return;
            setLoading(true);
            try {
                await addDoc(collection(db, "questions"), {
                    examId, text: formData.text, options: [formData.opt1, formData.opt2, formData.opt3, formData.opt4],
                    correctIndices: correctIndices.sort(), isSATA, rationale: formData.rationale, createdAt: serverTimestamp()
                });
                showNotification("Question added!");
                setFormData({ text: '', opt1: '', opt2: '', opt3: '', opt4: '', rationale: '' });
                setCorrectIndices([]);
            } catch (err) { showNotification("Error saving.", "error"); } finally { setLoading(false); }
        };

        if (!examId) return <div className="p-10 text-center text-slate-400">Please select an Exam from "My Exams" tab first.</div>;
        return (
            <div className="p-8 scroller overflow-y-auto h-full">
                <form onSubmit={handleSubmit} className="max-w-3xl mx-auto space-y-6">
                    <div className="flex justify-between items-center">
                        <div className="bg-blue-50 text-blue-700 px-3 py-1 rounded text-sm font-bold">Exam ID: {examId}</div>
                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={isSATA} onChange={(e) => { setIsSATA(e.target.checked); setCorrectIndices([]); }} className="w-5 h-5" /><span className="text-slate-700 font-semibold">SATA (Select All That Apply)</span></label>
                    </div>
                    <textarea name="text" value={formData.text} onChange={handleChange} required rows="3" className="w-full p-3 border rounded-lg outline-none focus:border-blue-500" placeholder="Question Stem..." />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">{[1, 2, 3, 4].map((num, idx) => (
                        <div key={num} className={`relative p-4 rounded-lg border ${correctIndices.includes(idx) ? 'border-green-500 bg-green-50' : 'border-slate-200'}`}>
                            <div className="flex justify-between mb-2"><span className="text-xs font-bold text-slate-500">Option {String.fromCharCode(65 + idx)}</span><button type="button" onClick={() => toggleCorrect(idx)} className={`w-6 h-6 rounded border flex items-center justify-center ${correctIndices.includes(idx) ? 'bg-green-500 text-white' : ''}`}><Icon name="check" size={14} /></button></div>
                            <input type="text" name={`opt${num}`} value={formData[`opt${num}`]} onChange={handleChange} required className="w-full p-2 bg-transparent border-b border-transparent focus:border-blue-500 outline-none" placeholder="Answer..." />
                        </div>
                    ))}</div>
                    <textarea name="rationale" value={formData.rationale} onChange={handleChange} required rows="2" className="w-full p-3 border rounded-lg outline-none focus:border-blue-500" placeholder="Rationale..." />
                    <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">{loading ? 'Saving...' : 'Save Question'}</button>
                </form>
            </div>
        );
    }

    // --- 4. QUESTION LIST ---
    function QuestionList({ db, examId, showNotification }) {
        const [questions, setQuestions] = React.useState([]);
        React.useEffect(() => {
            if (!examId) return;
            const q = query(collection(db, "questions"), where("examId", "==", examId));
            const unsubscribe = onSnapshot(q, (snap) => {
                const d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                d.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                setQuestions(d);
            });
            return () => unsubscribe();
        }, [examId]);
        const handleDelete = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "questions", id)); };

        if (!examId) return <div className="p-10 text-center text-slate-400">Select an exam first.</div>;
        if (questions.length === 0) return <div className="p-10 text-center text-slate-400">No questions found.</div>;

        return (
            <div className="h-full overflow-y-auto scroller">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50 sticky top-0"><tr><th className="p-4 border-b">Type</th><th className="p-4 border-b">Text</th><th className="p-4 border-b">Action</th></tr></thead>
                    <tbody>{questions.map(q => (
                        <tr key={q.id} className="hover:bg-slate-50">
                            <td className="p-4"><span className={`text-[10px] font-bold px-2 py-1 rounded ${q.isSATA ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}`}>{q.isSATA ? 'SATA' : 'Single'}</span></td>
                            <td className="p-4 truncate max-w-xs">{q.text}</td>
                            <td className="p-4"><button onClick={() => handleDelete(q.id)}><Icon name="trash" className="text-slate-400 hover:text-red-500" /></button></td>
                        </tr>
                    ))}</tbody>
                </table>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>
