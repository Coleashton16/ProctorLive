<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCLEX Exam Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f0f0f0; font-family: 'Arial', sans-serif; user-select: none; }
        .nclex-header { background: #e0e6ed; border-bottom: 2px solid #cbd5e1; }
        .nclex-next { background: #3b82f6; color: white; border: 1px solid #2563eb; }
        .nclex-next:hover { background: #1d4ed8; }
        .nclex-next:disabled { background: #94a3b8; border-color: #64748b; cursor: not-allowed; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, getDocs, doc, serverTimestamp, query, where, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCaex4bB5r2lVHPblC5pc0wCPIl8uUbtKw",
      authDomain: "proctorlive-dae37.firebaseapp.com",
      projectId: "proctorlive-dae37",
      storageBucket: "proctorlive-dae37.firebasestorage.app",
      messagingSenderId: "1063605117912",
      appId: "1:1063605117912:web:eea13aa3e743d55ee308ad",
      measurementId: "G-5RSFDE9W8Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function App() {
        const [view, setView] = React.useState('login');
        const [studentInfo, setStudentInfo] = React.useState(null);
        const [examData, setExamData] = React.useState(null);
        const [questions, setQuestions] = React.useState([]);

        const startExam = (info, data, qs) => {
            setStudentInfo(info);
            setExamData(data);
            setQuestions(qs);
            setView('exam');
        };

        return (
            <div className="h-screen w-screen overflow-hidden flex flex-col">
                {view === 'login' && <LoginScreen db={db} onJoin={startExam} />}
                {view === 'exam' && <ExamInterface db={db} student={studentInfo} exam={examData} questions={questions} onFinish={() => setView('finished')} />}
                {view === 'finished' && <FinishedScreen />}
            </div>
        );
    }

    function LoginScreen({ db, onJoin }) {
        const [examId, setExamId] = React.useState("");
        const [name, setName] = React.useState("");
        const [email, setEmail] = React.useState("");
        const [error, setError] = React.useState("");
        const [loading, setLoading] = React.useState(false);

        const handleJoin = async (e) => {
            e.preventDefault();
            setError("");
            setLoading(true);
            try {
                const examRef = doc(db, "exams", examId.trim());
                const examSnap = await getDoc(examRef);
                if (!examSnap.exists()) throw new Error("Exam ID not found.");
                const data = examSnap.data();

                if (data.allowedEmails && data.allowedEmails.length > 0) {
                    if (!data.allowedEmails.includes(email.trim())) throw new Error("Access Denied.");
                }

                const qQuery = query(collection(db, "questions"), where("examId", "==", examId.trim()));
                const qSnap = await getDocs(qQuery);
                if (qSnap.empty) throw new Error("No questions found.");
                const qs = qSnap.docs.map(d => ({id: d.id, ...d.data()})).sort(() => Math.random() - 0.5);

                const sessionId = `${email.replace(/[^a-zA-Z0-9]/g, '')}_${examId}`;
                await setDoc(doc(db, "sessions", sessionId), {
                    studentName: name, studentEmail: email, examId: examId, examTitle: data.title,
                    currentQuestionIndex: 0, totalQuestions: qs.length, status: 'active',
                    startTime: serverTimestamp(), // Track when they started
                    lastActive: serverTimestamp(), answers: {}
                });
                onJoin({ name, email, sessionId }, { id: examId, ...data }, qs);
            } catch (err) { setError(err.message); } finally { setLoading(false); }
        };

        return (
            <div className="flex-1 flex items-center justify-center bg-slate-200">
                <div className="bg-white p-8 rounded shadow-md max-w-md w-full border-t-4 border-blue-600">
                    <h1 className="text-2xl font-bold text-slate-800 mb-1">Student Login</h1>
                    <p className="text-slate-500 text-sm mb-6">Enter your details to begin.</p>
                    {error && <div className="bg-red-50 text-red-600 p-3 text-sm rounded mb-4">{error}</div>}
                    <form onSubmit={handleJoin} className="space-y-4">
                        <input required type="text" placeholder="Full Name" className="w-full p-2 border rounded" value={name} onChange={e => setName(e.target.value)} />
                        <input required type="email" placeholder="Email" className="w-full p-2 border rounded" value={email} onChange={e => setEmail(e.target.value)} />
                        <input required type="text" placeholder="Exam ID" className="w-full p-2 border rounded font-mono" value={examId} onChange={e => setExamId(e.target.value)} />
                        <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">{loading ? "Verifying..." : "Begin Exam"}</button>
                    </form>
                </div>
            </div>
        );
    }

    function ExamInterface({ db, student, exam, questions, onFinish }) {
        const [currentIndex, setCurrentIndex] = React.useState(0);
        const [selectedIndices, setSelectedIndices] = React.useState([]);
        const [submitting, setSubmitting] = React.useState(false);
        const [timeLeft, setTimeLeft] = React.useState(null);

        const currentQ = questions[currentIndex];
        const isLast = currentIndex === questions.length - 1;

        // --- TIMER LOGIC ---
        React.useEffect(() => {
            const limitMins = exam.timeLimit || 60; // Default 60 mins
            const durationSecs = limitMins * 60;
            setTimeLeft(durationSecs);

            const timer = setInterval(() => {
                setTimeLeft(prev => {
                    if (prev <= 1) {
                        clearInterval(timer);
                        handleFinish(); // Auto-submit
                        return 0;
                    }
                    return prev - 1;
                });
            }, 1000);
            return () => clearInterval(timer);
        }, []);

        const formatTime = (secs) => {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        const handleOptionSelect = (optIdx) => {
            if (currentQ.isSATA) {
                if (selectedIndices.includes(optIdx)) setSelectedIndices(selectedIndices.filter(i => i !== optIdx));
                else setSelectedIndices([...selectedIndices, optIdx]);
            } else setSelectedIndices([optIdx]);
        };

        const handleNext = async () => {
            setSubmitting(true);
            try {
                const sessionRef = doc(db, "sessions", student.sessionId);
                await updateDoc(sessionRef, {
                    [`answers.${currentQ.id}`]: {
                        questionId: currentQ.id, selectedOptions: selectedIndices, timestamp: new Date().toISOString()
                    },
                    currentQuestionIndex: currentIndex + 1, lastActive: serverTimestamp()
                });

                if (isLast) handleFinish();
                else { setSelectedIndices([]); setCurrentIndex(prev => prev + 1); setSubmitting(false); }
            } catch (err) { alert("Error saving answer."); setSubmitting(false); }
        };

        const handleFinish = async () => {
            setSubmitting(true);
            try {
                await updateDoc(doc(db, "sessions", student.sessionId), { status: 'completed' });
                onFinish();
            } catch (e) { console.error(e); }
        };

        return (
            <div className="flex flex-col h-full bg-white relative">
                <header className="nclex-header p-2 flex justify-between items-center h-14 shrink-0 px-6">
                    <div className="text-sm font-bold text-slate-700">{student.name} | {exam.title}</div>
                    <div className="flex gap-4 text-sm font-mono items-center">
                        <div className="bg-slate-200 px-3 py-1 rounded">Question {currentIndex + 1} / {questions.length}</div>
                        <div className={`font-bold text-lg ${timeLeft < 60 ? 'text-red-600 animate-pulse' : 'text-slate-700'}`}>
                            Time: {timeLeft !== null ? formatTime(timeLeft) : '--:--'}
                        </div>
                    </div>
                </header>
                <div className="flex-1 flex overflow-hidden">
                    <div className="w-1/2 p-8 overflow-y-auto border-r border-slate-200 bg-white">
                        <h2 className="text-xl leading-relaxed text-slate-800 font-medium">{currentQ.text}</h2>
                        {currentQ.isSATA && <div className="mt-4 p-3 bg-blue-50 text-blue-800 text-sm font-bold border border-blue-100 inline-block rounded">Select all that apply.</div>}
                    </div>
                    <div className="w-1/2 p-8 bg-slate-50 overflow-y-auto flex flex-col justify-between">
                        <div className="space-y-4">
                            {currentQ.options.map((opt, idx) => {
                                const isSelected = selectedIndices.includes(idx);
                                return (
                                    <div key={idx} onClick={() => handleOptionSelect(idx)} className={`flex gap-4 p-4 rounded border-2 cursor-pointer hover:bg-white hover:shadow-sm items-start ${isSelected ? 'border-blue-600 bg-white shadow-md' : 'border-slate-200 bg-white'}`}>
                                        <div className={`w-6 h-6 shrink-0 flex items-center justify-center border-2 rounded-full mt-0.5 ${isSelected ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-300'}`}>{isSelected && <span className="text-xs">‚óè</span>}</div>
                                        <div className="text-lg text-slate-700">{opt}</div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-10 flex justify-end pt-6 border-t border-slate-200">
                            <button onClick={handleNext} disabled={selectedIndices.length === 0 || submitting} className="nclex-next px-8 py-3 rounded text-lg font-bold shadow-sm flex items-center gap-2">
                                {submitting ? 'Saving...' : (isLast ? 'Submit Exam' : 'Next Question')}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    function FinishedScreen() {
        return (
            <div className="flex-1 flex flex-col items-center justify-center bg-slate-100 text-center p-8">
                <div className="bg-white p-12 rounded-lg shadow-lg max-w-lg border-t-8 border-green-500">
                    <h2 className="text-3xl font-bold text-slate-800 mb-4">Exam Completed</h2>
                    <p className="text-slate-600 mb-8 text-lg">Your answers have been recorded. You may close this window.</p>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
